<!DOCTYPE html>
<html lang="da" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ page_title|default:"Vagt" }}{% endblock %} - Watchtower</title>

    <!-- Favicon: Shield with checkmark matching the Watchtower brand -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cpath fill='%232563eb' d='M16 2C12.5 2 8.5 3.5 5 5v10c0 8 5 12 11 15 6-3 11-7 11-15V5c-3.5-1.5-7.5-3-11-3z'/%3E%3Cpath fill='white' d='M14 19l-4-4 2-2 2 2 6-6 2 2-8 8z'/%3E%3C/svg%3E">

    {% load static %}

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind for dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Custom colors for the vagt system
                        vagt: {
                            primary: '#2563eb',
                            secondary: '#64748b',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Custom styles -->
    <style type="text/tailwindcss">
        @layer utilities {
            /* Smooth transitions for dark mode */
            .theme-transition {
                @apply transition-colors duration-200;
            }

            /* Loading indicator for HTMX requests */
            .htmx-request .htmx-indicator {
                @apply opacity-100;
            }
            .htmx-indicator {
                @apply opacity-0 transition-opacity duration-200;
            }

            /* Toast animation */
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            .toast-enter {
                animation: slideIn 0.3s ease-out forwards;
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            .toast-exit {
                animation: slideOut 0.3s ease-in forwards;
            }

            /* Progress bar animation for undo timer */
            @keyframes shrink {
                from { width: 100%; }
                to { width: 0%; }
            }
            .undo-progress {
                animation: shrink linear forwards;
            }
        }
    </style>

    {% block extra_css %}{% endblock %}

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4" defer></script>

    <!-- Dark mode initialization (before page render to prevent flash) -->
    <script>
        (function() {
            // Check localStorage or system preference
            const stored = localStorage.getItem('theme');
            if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 theme-transition"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

    <!-- Main container -->
    <div class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm theme-transition sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo / Brand -->
                    <div class="flex items-center">
                        <a href="{% url 'vagt:board' %}" class="flex items-center space-x-2">
                            <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            <span class="text-xl font-semibold text-gray-900 dark:text-white">Watchtower</span>
                        </a>
                    </div>

                    <!-- Navigation -->
                    <nav class="hidden md:flex items-center space-x-4">
                        {% if user.is_authenticated %}
                        <a href="{% url 'vagt:board' %}"
                           class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 theme-transition">
                            Vagtplan
                        </a>
                        <a href="{% url 'vagt:log' %}"
                           class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 theme-transition">
                            Log
                        </a>
                        <a href="{% url 'vagt:controllers' %}"
                           class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 theme-transition">
                            Controllere
                        </a>
                        {% if user.is_superuser %}
                        <a href="{% url 'vagt:docs' %}"
                           class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 theme-transition">
                            Dokumentation
                        </a>
                        <a href="{% url 'admin:index' %}"
                           class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 theme-transition">
                            Admin
                        </a>
                        {% endif %}
                        {% endif %}
                    </nav>

                    <!-- User menu and theme toggle -->
                    <div class="flex items-center space-x-4">
                        {% if user.is_authenticated %}
                        <a href="{% url 'vagt:profile' %}" class="hidden sm:inline text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                            {{ user.username }}
                        </a>
                        <a href="{% url 'logout' %}"
                           class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md theme-transition">
                            Log ud
                        </a>
                        {% endif %}
                        <button id="theme-toggle"
                                type="button"
                                class="p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 theme-transition"
                                aria-label="Toggle dark mode">
                            <!-- Sun icon (shown in dark mode) -->
                            <svg class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Moon icon (shown in light mode) -->
                            <svg class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                            </svg>
                        </button>

                        <!-- Mobile menu button -->
                        <button id="mobile-menu-button"
                                type="button"
                                class="md:hidden p-2 rounded-md text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                aria-label="Open menu">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 dark:border-gray-700">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    {% if user.is_authenticated %}
                    <a href="{% url 'vagt:profile' %}" class="block px-3 py-2 text-sm text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700 mb-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Logget ind som <span class="font-medium text-gray-900 dark:text-white">{{ user.username }}</span>
                    </a>
                    <a href="{% url 'vagt:board' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Vagtplan
                    </a>
                    <a href="{% url 'vagt:log' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Log
                    </a>
                    <a href="{% url 'vagt:controllers' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Controllere
                    </a>
                    {% if user.is_superuser %}
                    <a href="{% url 'vagt:docs' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Dokumentation
                    </a>
                    <a href="{% url 'admin:index' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Admin
                    </a>
                    {% endif %}
                    <a href="{% url 'logout' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Log ud
                    </a>
                    {% else %}
                    <a href="{% url 'login' %}"
                       class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                        Log ind
                    </a>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-1">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 theme-transition">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <p class="text-center text-sm text-gray-500 dark:text-gray-400">
                    &copy; {% now "Y" %} FynBus - Watchtower
                    <span class="mx-2">Â·</span>
                    <span class="text-gray-400 dark:text-gray-500">
                        v{{ app_version }}{% if app_version_date %} ({{ app_version_date|date:"d/m/Y" }}){% endif %}
                    </span>
                </p>
            </div>
        </footer>
    </div>

    <!-- Undo toast container (fixed position for OOB swaps) -->
    <div id="undo-container" class="fixed bottom-4 right-4 z-50 space-y-2">
        <!-- Undo toasts will be inserted here via HTMX OOB swap -->
    </div>

    <!-- Audit tooltip container (for hover/tap popups) -->
    <div id="audit-tooltip-container" class="fixed z-50 pointer-events-none">
        <!-- Audit tooltips rendered here -->
    </div>

    <!-- Scripts -->
    <script>
        // Theme toggle functionality
        document.getElementById('theme-toggle').addEventListener('click', function() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        });

        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Handle undo toast auto-dismiss
            const toast = event.detail.target.querySelector('[data-undo-toast]');
            if (toast) {
                const duration = parseInt(toast.dataset.undoDuration) * 1000;
                setTimeout(function() {
                    toast.classList.remove('toast-enter');
                    toast.classList.add('toast-exit');
                    setTimeout(function() {
                        toast.remove();
                    }, 300);
                }, duration);
            }
        });

        // Close audit tooltip when clicking outside
        document.addEventListener('click', function(event) {
            const tooltips = document.querySelectorAll('[data-audit-tooltip]');
            tooltips.forEach(function(tooltip) {
                if (!tooltip.contains(event.target) && !event.target.closest('[data-audit-trigger]')) {
                    tooltip.remove();
                }
            });
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
